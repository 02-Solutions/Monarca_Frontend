name: Check PR Target Branch
on:
  pull_request:
    types: [opened, edited, reopened, synchronize]
jobs:
  check-target-branch:
    runs-on: ubuntu-latest
    steps:
      - name: Debug PR Information
        env:
          GH_TOKEN: ${{ github.token }}
          GITHUB_EVENT_PATH: ${{ github.event_path }}
        run: |
          # Print the actual event payload for debugging
          echo "Contents of event payload:"
          cat $GITHUB_EVENT_PATH

          # Get PR number from the event payload
          PR_NUMBER=$(jq -r .pull_request.number $GITHUB_EVENT_PATH)
          REPO="${{ github.repository }}"

          echo "PR Number: $PR_NUMBER"
          echo "Repo: $REPO"

          # Get PR data directly from GitHub API
          PR_DATA=$(gh api repos/$REPO/pulls/$PR_NUMBER)

          # Extract base and head branch names using jq
          BASE_BRANCH=$(echo "$PR_DATA" | jq -r .base.ref)
          HEAD_BRANCH=$(echo "$PR_DATA" | jq -r .head.ref)

          echo "API BASE_BRANCH: $BASE_BRANCH"
          echo "API HEAD_BRANCH: $HEAD_BRANCH"

          # Set these as outputs for the next step
          echo "base_branch=$BASE_BRANCH" >> $GITHUB_OUTPUT
          echo "head_branch=$HEAD_BRANCH" >> $GITHUB_OUTPUT
        id: pr_info

      - name: Check PR target
        env:
          TARGET_BRANCH: ${{ steps.pr_info.outputs.base_branch }}
          SOURCE_BRANCH: ${{ steps.pr_info.outputs.head_branch }}
        run: |
          echo "Pull Request from $SOURCE_BRANCH to $TARGET_BRANCH"

          # Check if this is a PR to main
          if [[ "$TARGET_BRANCH" == "main" ]]; then
            # Check if source branch is allowed to target main (only develop)
            if [[ "$SOURCE_BRANCH" == "develop" ]]; then
              echo "✅ Valid PR: $SOURCE_BRANCH can target main"
            else
              echo "::error::❌ BRANCH TARGET ERROR: Invalid PR from '$SOURCE_BRANCH' to 'main'"
              echo "::error::According to our GitFlow process, PRs to 'main' can ONLY come from:"
              echo "::error::- develop (for planned releases)"
              echo "::error::Please close this PR and create a new one targeting 'develop' instead."
              exit 1
            fi
          else
            echo "✅ This PR is targeting '$TARGET_BRANCH', no restrictions apply"
          fi
